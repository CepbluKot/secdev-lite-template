# S05 - Матрицы вариантов (сводно) — R-01…R-05

## R-01 — Компрометация токена / захват аккаунта (Edge: Internet → API (JWT))
NFR links: NFR-202, NFR-305, NFR-101

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | JWT TTL 15m + Refresh 7d + отзыв | 4 | 3 | 2 | 2 | 2 | 7 | 6 | +1 | Быстрый запуск, паттерн 1 |
| O2 | Обязательное MFA / step-up для критичных действий | 5 | 4 | 3 | 3 | 2 | 9 | 8 | +1 | Высокая безопасность, ухудшение UX |
| O3 | Жёсткие лимиты auth + привязка устройства | 3 | 2 | 2 | 1 | 2 | 5 | 5 | 0 | Снижает brute-force, операционная нагрузка |

Recommendation: внедрить O1 в первую очередь, затем O3; O2 — для админов / VIP.

---

## R-02 — Утечка PII в логах/БД (Node: Service/DB/Logs)
NFR links: NFR-103, NFR-303, NFR-106

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Маскирование PII в логах и редактирование полей на уровне логгера | 4 | 4 | 2 | 1 | 1 | 8 | 4 | +4 | Быстро и мало зависимостей |
| O2 | Политика хранения: raw PII ≤7 дней + фоновые purge-job'ы | 3 | 3 | 2 | 2 | 2 | 6 | 6 | 0 | Требуется аккуратная реализация очистки |
| O3 | Шифрование полей PII в БД и управление ключами | 5 | 5 | 4 | 4 | 3 | 10 | 11 | -1 | Сильно снижает риск, но дорого/сложно |

Recommendation: O1 + O2; O3 — для особо чувствительных полей.

---

## R-03 — Зависание внешнего провайдера (Edge: Service → External API)
NFR links: NFR-102, NFR-104

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Таймаут ≤2s + retry≤3 (jitter) + circuit-breaker | 3 | 3 | 2 | 1 | 1 | 6 | 4 | +2 | Паттерн 6, базовая защита |
| O2 | Асинхронный fallback: очередь, 202 + background job | 4 | 4 | 4 | 3 | 3 | 8 | 10 | -2 | Для non-blocking сценариев; сложнее UX |
| O3 | Кэш с коротким TTL ответов провайдера (5–30s) | 2 | 2 | 2 | 1 | 1 | 4 | 4 | 0 | Уменьшает вызовы, риск устаревших данных |

Recommendation: O1 как базовая защита; O2 — для операций, терпимых к eventual consistency.

---

## R-04 — Манипуляция полей заказа (Edge: Internet → API order input)
NFR links: NFR-206, NFR-302, NFR-205

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Серверная валидация схемы + reject extra fields | 4 | 3 | 2 | 1 | 1 | 7 | 4 | +3 | Паттерн 3, быстрая защита |
| O2 | Канонизация + integrity checks (нормализация, подпись полей) | 3 | 3 | 3 | 2 | 2 | 6 | 7 | -1 | Снижает логические ошибки |
| O3 | Idempotency keys + хеширование полезной нагрузки для записей | 2 | 2 | 2 | 2 | 1 | 4 | 5 | -1 | Защита от повторов/дубликатов |

Recommendation: O1 первично; O2 — при сложной нормализации.

---

## R-05 — Массовые запросы / спам заказов (Edge: Internet → API)
NFR links: NFR-201, NFR-101, NFR-301

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Глобальные и per-user rate limits (напр., 60 req/min) + 429 | 4 | 3 | 2 | 1 | 1 | 7 | 4 | +3 | Быстро через gateway |
| O2 | Квоты по планам + прогрессивное throttling + captcha | 4 | 4 | 3 | 3 | 2 | 8 | 8 | 0 | Долгосрочная продуктовая политика |
| O3 | Idempotency / верификация для массовых операций | 3 | 3 | 3 | 2 | 2 | 6 | 7 | -1 | Для batch endpoint'ов |

Recommendation: внедрить O1 на gateway немедленно; планировать O2 как политику продукта.

--- 

Конец сводных матриц.